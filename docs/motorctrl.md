# モーター制御関連の設定

このデコーダソフトウェアによるモーター制御は、40kHzの周波数によるPWM制御をベースとして、モーターの逆起電力(BEMF)によるフィードバック制御や、低周波成分をPWM信号に含めることによるモーターの低速回転支援機能によって構成されています。

BEMFによるフィードバック制御で、勾配やけん引する車両数など、負荷が変動した際もスロットルで指定した一定の速度で走るように制御されます。

また、モーターの低速回転支援機能により、モーターがスロースタートしやすくなり、なめらかな発進や安定した低速走行を行うことが可能となります。

それぞれの機能は、CV値の設定により個別にオンオフできます。

---

## BEMF制御の有効・無効化方法

CV60のBit8を「1」にすると有効、「0」にすると無効となります。

簡単な見分け方としては、CV60の値が128以上であればBEMF制御が有効となっています。

---

## モーターの低速回転支援機能の設定方法

関連するCV値:

* CV60: 低速回転支援機能の動作設定
* CV61: スロットル指定値が「1」の際の、高周波PWMデューティーの最低値
* CV62: 低速回転支援機能を無効にするスロットル指定値の値

CV60のBit0、Bit1が低速回転支援機能の設定ビットとなります。

それぞれのビットの設定により、動作が異なります。

<table>
  <tr>
    <th>Bit1</th>
    <th>Bit0</th>
    <th>10進数</th>
    <th>低速回転支援機能の動作</th>
  </tr>
  <tr>
    <td>0</td>
    <td>0</td>
    <td>0</td>
    <td>無効 (40kHz PWMによる通常の制御のみ)</td>
  </tr>
  <tr>
    <td>0</td>
    <td>1</td>
    <td>1</td>
    <td>低周波成分: 60Hz</td>
  </tr>
  <tr>
    <td>1</td>
    <td>0</td>
    <td>2</td>
    <td>低周波成分: 120Hz</td>
  </tr>
  <tr>
    <td>1</td>
    <td>1</td>
    <td>3</td>
    <td>低周波成分: 30Hz</td>
  </tr>
</table>

---

モーターの低速回転支援機能が有効となっている場合、40kHz PWMによる制御に加え、低周波成分にもデューティー比が加わる動作をするため、実効デューティーがかなり低い値となります。

そのため、低周波成分を重ね合わせる制御を行う場合は、指令値に対して出力するデューティー比を上げてから低周波成分と掛け合わせることで出力の実効値を補正する動作を行います。

補正時の初期値は、CV61で決定します。

(基本的に、小さい値にすればするほどスロットル指定値が低い状態ではモーターがほとんど回転しない状態になります。)

---

モーター低速回転支援機能を無効とするスロットル指定値を、CV62で指定します。

スロットル指定値がCV62の値を超えると、低周波成分をPWM出力にかけ合わせる制御をやめるように動作します。

CV61とCV62の値から、スロットルの指定値がゼロの状態からCV62の値に達するまでの間で、なめらかに動作するように計算を行って動作します。


---

## モーター制御に関連するCV番号・内容

<table>
  <tr>
    <th>CV番号</th>
    <th>初期値</th>
    <th>設定内容</th>
  </tr>
  <tr>
    <td>55</td>
    <td>30</td>
    <td>BEMFパラメータ (Kp)</td>
  </tr>
  <tr>
    <td>56</td>
    <td>10</td>
    <td>BEMFパラメータ (Ki)</td>
  </tr>
  <tr>
    <td>57</td>
    <td>40</td>
    <td>BEMFパラメータ (Kd)</td>
  </tr>
  <tr>
    <td>60</td>
    <td>131</td>
    <td>モーター制御設定
    <br>Bit8: BEMF On/Off
    <br>Bit1-0: モーター低速回転支援機能の周波数設定
    <br>(0: 無効 / 1: 60Hz / 2: 120Hz / 3: 30Hz)</td>
  </tr>
  <tr>
    <td>61</td>
    <td>95</td>
    <td>モーター低速回転支援機能の設定
    <br>(PWMデューティーの最低値)</td>
  </tr>
  <tr>
    <td>62</td>
    <td>192</td>
    <td>モーター低速回転支援機能の設定
    <br>(無効とする速度値)</td>
  </tr>
  <tr>
    <td>138</td>
    <td>100</td>
    <td>BEMF ADCポートのスケーリング値</td>
  </tr>
</table>


